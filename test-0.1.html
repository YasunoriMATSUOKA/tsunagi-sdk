<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine.min.css">
</head>
<body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine-html.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/boot.min.js"></script>
<script src="https://bundle.run/buffer@6.0.3"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.2/nacl-fast.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js"></script>

<script src="./tsunagi-sdk-0.1.js"></script>
<script>


jasmine.DEFAULT_TIMEOUT_INTERVAL =240000;
describe('tsunagi-sdk.0.1',() => {

	beforeEach(async()=>{
	});

	afterEach(async()=>{
	});

	beforeAll(async()=>{

		this.privateKey = "94ee0f4d7fe388ac4b04a6a6ae2ba969617879b83616e4d25710d688a89d80c7";
		this.bobPrivateKey = "fa6373f4f497773c5cc55c103e348b139461d61fd4b45387e69d08a68000e06b";
		this.carolPrivateKey = "1e090b2a266877a9f88a510af2eb0945a63dc69dbce674ccd83272717d4175cf";

		this.network = {
			version:1,
			network:'TESTNET',
			generationHash:'7fccd304802016bebbcd342a332f91ff1f3bb5e902988b352697be245f48e836',
			currencyMosaicId:0x3A8416DB2D53B6C8n,
			currencyNamespaceId:0xE74B99BA41F4AFEEn,
			currencyDivisibility:6,
			epochAdjustment:1637848847,
			catjasonBase:"https://xembook.github.io/tsunagi-sdk/catjson/",
			wellknownNodes:[
				'https://sym-test.opening-line.jp:3001',
				'https://sym-test.opening-line.jp:3001',
				'https://sym-test.opening-line.jp:3001',
			]
		}

		let now = this.network.epochAdjustment * 1000;
//		let now = Date.now(); //実際に使用できるpayloadを出力する場合（テストはエラーになります）
		let secs = 7200; //2時間後を期限とする場合
		let value = ((Math.trunc(now / 1000) + secs) - this.network.epochAdjustment) * 1000;
		this.deadline = BigInt(value);

		
	});

	xdescribe('aggregate complete transaction', () => {

		it('resolves 3 account transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Bob.",
			}
			//Caroll->Alice
			let tx3 = {
				type:'TRANSFER',
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				recipient_address:"TBUXMJAYYW3EH3XHBZXSBVGVKXKZS4EH26TINKI",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Alice, This is Carol.",
			}

			let cosignature1 = {
				version:0n,
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				signature:"",
			}

			let cosignature2 = {
				version:0n,
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				signature:"",
			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2,tx3],
				cosignatures:[cosignature1,cosignature2]
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			//連署
			cosignature1.signature = cosignTransaction(txHash,this.bobPrivateKey);
			cosignature2.signature = cosignTransaction(txHash,this.carolPrivateKey);

			let cosignaturesLayout = layout.find(lf=>lf.name === "cosignatures");
			let parsedCosignatures = await parseTransaction(preparedTx,[cosignaturesLayout],catjson,network); //構築
			builtTx = updateTransaction(builtTx,"cosignatures","layout",parsedCosignatures[0].layout);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"2803000000000000124c4cb111caa9e6b70e363ffbdd3e1e7880b818ab1e6e90ad5bcc0741952ca5a29fe2c8fe2e85ad28701926bfc3cce345c8faf00ca37e766016ef1cd141a7005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f000000000068ca07a982feffffae67220a53b24a241f2da951ba6cfe044aedc42a0afb5f2742c5a454e3c9c6e1b0010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008a000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afec000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821a00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320426f622e0000000000008c00000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4e00000000019854419869762418c5b643eee70e6f20d4d555d5997087d7a686a91c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f20416c6963652c2054686973206973204361726f6c2e0000000000000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afecbd92ad19a7b1e2b15a53c6ff03123fc664ebb299ae640b49f3eafb817a3b9309f2d0f8824226a7a29bf6e3a06c069d390f6d415eb3e68a0582774d201bcce4000000000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4eca42050a48185bdfadeb01f1a85d2770c2227bbd8e3efd30d4e6f405a49b10ee7ca0e87f739c95c2ae72259858c0acbe98313c5f174ad5790b6d155981c9bb0f"
			);

		});

		it('resolves opposite cosignature', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Bob.",
			}
			//Caroll->Alice
			let tx3 = {
				type:'TRANSFER',
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				recipient_address:"TBUXMJAYYW3EH3XHBZXSBVGVKXKZS4EH26TINKI",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Alice, This is Carol.",
			}

			let cosignature1 = {
				version:0n,
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				signature:"",
			}

			let cosignature2 = {
				version:0n,
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				signature:"",
			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2,tx3],
				cosignatures:[cosignature2,cosignature1]
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			//連署
			cosignature1.signature = cosignTransaction(txHash,this.bobPrivateKey);
			cosignature2.signature = cosignTransaction(txHash,this.carolPrivateKey);

			let cosignaturesLayout = layout.find(lf=>lf.name === "cosignatures");
			let parsedCosignatures = await parseTransaction(preparedTx,[cosignaturesLayout],catjson,network); //構築
			builtTx = updateTransaction(builtTx,"cosignatures","layout",parsedCosignatures[0].layout);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"2803000000000000124c4cb111caa9e6b70e363ffbdd3e1e7880b818ab1e6e90ad5bcc0741952ca5a29fe2c8fe2e85ad28701926bfc3cce345c8faf00ca37e766016ef1cd141a7005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f000000000068ca07a982feffffae67220a53b24a241f2da951ba6cfe044aedc42a0afb5f2742c5a454e3c9c6e1b0010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008a000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afec000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821a00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320426f622e0000000000008c00000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4e00000000019854419869762418c5b643eee70e6f20d4d555d5997087d7a686a91c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f20416c6963652c2054686973206973204361726f6c2e000000000000000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4eca42050a48185bdfadeb01f1a85d2770c2227bbd8e3efd30d4e6f405a49b10ee7ca0e87f739c95c2ae72259858c0acbe98313c5f174ad5790b6d155981c9bb0f00000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afecbd92ad19a7b1e2b15a53c6ff03123fc664ebb299ae640b49f3eafb817a3b9309f2d0f8824226a7a29bf6e3a06c069d390f6d415eb3e68a0582774d201bcce400"
			);

		});
		

		it('resolves no cosignature', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Alice.",
			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2],
				cosignatures:[]

			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			console.log(txHash)
			expect(payload)
			.toEqual(
				"c801000000000000de1c479cd05d024bf78fe68a4f064ae9c0ea7ca00bd0c2ec392a55cc30cfda49a7334619ef33b25e71c287d9948691b3422cbdc90ffd9f81d269620b57d0370a5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f000000000068ca07a982feffff00de2f57a150d1073330b9d3273c651b675ed9ce2f200cac1d29717dffe6fe3120010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320416c6963652e00000000"
			);

		});

		it('resolves undefined cosignature', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Alice.",
			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2],
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"c801000000000000de1c479cd05d024bf78fe68a4f064ae9c0ea7ca00bd0c2ec392a55cc30cfda49a7334619ef33b25e71c287d9948691b3422cbdc90ffd9f81d269620b57d0370a5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f000000000068ca07a982feffff00de2f57a150d1073330b9d3273c651b675ed9ce2f200cac1d29717dffe6fe3120010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320416c6963652e00000000"
			);
		});

	}); // aggregate complete transaction


	xdescribe('aggregate bonded transaction', () => {

		it('resolves 3 account transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Bob.",
			}
			//Caroll->Alice
			let tx3 = {
				type:'TRANSFER',
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				recipient_address:"TBUXMJAYYW3EH3XHBZXSBVGVKXKZS4EH26TINKI",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Alice, This is Carol.",
			}


			let aggTx = {
				type:'AGGREGATE_BONDED',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2,tx3],
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload);
			console.log(txHash);
			expect(payload)
			.toEqual(
				"58020000000000007898769b86e9e84ed7980afe4733278f7c838fe9c02e32ceda3ebaaa692be899690087171e61bfa93866552acc7660ef9fab6307f54bb1702087faf0e80d3e035f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414240420f000000000068ca07a982feffffae67220a53b24a241f2da951ba6cfe044aedc42a0afb5f2742c5a454e3c9c6e1b0010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008a000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afec000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821a00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320426f622e0000000000008c00000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4e00000000019854419869762418c5b643eee70e6f20d4d555d5997087d7a686a91c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f20416c6963652c2054686973206973204361726f6c2e00000000"
			);

		});

	}); // aggregate bonded transaction


	xdescribe('transfer transaction', () => {

		it('resolves 2 mosaic transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"dc00000000000000baef5cd699f98641939427f7ffdc347b671150838e7b7ebf3b7e61ff3ad77e23cc3472d47e5eeca811af56fdda3fb823b4d6b428e7146659275a5beb7ced07005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21"
			);
		});

		it('resolves opposite mosaice order', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"dc00000000000000baef5cd699f98641939427f7ffdc347b671150838e7b7ebf3b7e61ff3ad77e23cc3472d47e5eeca811af56fdda3fb823b4d6b428e7146659275a5beb7ced07005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21"
			);
		})

		it('resolves null message', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"",
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);

			console.log(payload);
			console.log(txHash);

			expect(payload)
			.toEqual(
				"c1000000000000002662637cca6686223e4aa6489d9bdf9fd8bf21a434b9a8188931f9e07ec54570e620f783ee7bab2c149651ac22a0227e713290a0d0c00e30d2ae7986dc71e00c5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b80100020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a640000000000000000"
			);
		})


		it('resolves undefined message', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"c000000000000000122b13f2b300efca963d2d9b5a2e0866fd26b4485b9570d9a65f50b22e62f59ebf5119ddb322d5b8e02a0fa656bf3698fe7368185e2f044e9a4956b8588aee045f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b80000020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a6400000000000000"
			);
		})

		it('resolves null mosaic transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[],
				message:"Hello Tsunagi(Catjson) SDK!",
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload);
			console.log(txHash);

			expect(payload)
			.toEqual(
				"bc000000000000000d4e33b1cba70440b409fa920d986ad850cb3f59c97bd291b44ce1032706120dc5ff0fc2eea15c70c41b76d68eeab90fdf4567843712e3b769d3eb83da96050f5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21"
			);
		});


		it('resolves undefined message and null mosaic', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[],
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload);
			console.log(txHash);

			expect(payload)
			.toEqual(
				"a000000000000000484efd8ed8b497e89d900d1449f3b883e3240c1c77fcfe13348ade3737c630a777be72803e836d3a4d04d70f1d8346637ee34e702deba6dc18be3422950ba80f5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b80000000000000000"
			);
		})

		it('resolves null message and null mosaic', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[],
				message:""
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload);
			console.log(txHash);
			expect(payload)
			.toEqual(
				"a100000000000000a6f9b18330928bbc266c663d8fb0ea44556246527ab14f6d5737657b88415d0ecca8f4f65c9e25b55a948189b3a80f610fe3e30827299a0a6f0560449f9b29055f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a86100000000000068ca07a982feffff989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b8010000000000000000"
			);
		})


	});

	describe('mosaic transaction', () => {

		//Failure_Mosaic_Modification_Disallowed
		it('resolves mosaic definition', async () => {

			let tx1 = {
				type:'MOSAIC_DEFINITION',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				duration: 0n,
				id:0x4DAFFBE5505DE676n,
				nonce: 1700836761,
				flags: 'TRANSFERABLE RESTRICTABLE',
				divisibility: 2
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			console.log(txHash)
			expect(payload)
			.toEqual(
				"96000000000000008400ea1dd86f206c946ae4aacfdd2d9997ceb406028e3d3e67e0b20a2a0dae696d9084f7f38f64c56450a3d6cd305722cb37d60b462358bbe23b5d8e155a3f0f5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001984d41a86100000000000000dd6d000000000076e65d50e5fbaf4d000000000000000099b560650602"
			);
		});

		it('resolves mosaic supply change', async () => {

			let tx1 = {
				type: 'MOSAIC_SUPPLY_CHANGE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				mosaic_id:0x4DAFFBE5505DE676n,
				delta: 1000n * 100n, // assuming divisibility = 2
				action: 'INCREASE'
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			console.log(txHash)
			expect(payload)
			.toEqual(
				"9100000000000000cbec54081f0a62d5c5f84748df4668670fad447b53b44062e58d5cab054a2c8bcd8ab13533231825eda6156d4c73ba98978eccb011b0107f9bc9a0f071888e035f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001984d42a86100000000000000dd6d000000000076e65d50e5fbaf4da08601000000000001"
			);
		});

		it('resolves aggregate mosaic definition and supply change', async () => {

			//buffer.Buffer.from(nonce.nonce).readUInt32LE();
			//buffer.Buffer.from(new Uint32Array([699275411]).buffer).toString("hex");
			//sym.MosaicId.createFromNonce(nonce, alice.address).toHex();

			let tx1 = {
				type:'MOSAIC_DEFINITION',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				duration: 0n,
				id:0x4DAFFBE5505DE676n,
				nonce: 1700836761,
				flags: 'TRANSFERABLE RESTRICTABLE',
				divisibility: 2
			}

			let tx2 = {
				type: 'MOSAIC_SUPPLY_CHANGE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				mosaic_id:0x4DAFFBE5505DE676n,
				delta: 1000n * 100n, // assuming divisibility = 2
				action: 'INCREASE'

			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2],
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload);
			console.log(txHash)

			expect(payload)
			.toEqual(
				"3801000000000000c4b2ea423fd6eaa69407fb261cdb09b3d039923ad15a120ad1f1da61bcfd69db9b71cddc0bff730b3cd1b421b35f8cbc87a4765a204412b5efc34e221d50b20a5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f000000000000dd6d0000000000fc4405540b555f4dde5dc4ce67daeaf207e5485d8da24d5cfd6bf71fa064c9a5900000000000000046000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001984d4176e65d50e5fbaf4d000000000000000099b560650602000041000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001984d4276e65d50e5fbaf4da0860100000000000100000000000000"
			);
		});



	});
});//symbol-sdk
</script>

</body>
</html>
