<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine.min.css">
</head>
<body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/jasmine-html.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.3.0/boot.min.js"></script>
<script src="https://bundle.run/buffer@6.0.3"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.2/nacl-fast.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js"></script>

<script src="./tsunagi-sdk-0.1.js"></script>
<script>


jasmine.DEFAULT_TIMEOUT_INTERVAL =240000;
describe('tsunagi-sdk.0.1',() => {


	beforeEach(async()=>{
	});

	beforeAll(async()=>{

		this.privateKey = "94ee0f4d7fe388ac4b04a6a6ae2ba969617879b83616e4d25710d688a89d80c7";
		this.bobPrivateKey = "fa6373f4f497773c5cc55c103e348b139461d61fd4b45387e69d08a68000e06b";
		this.carolPrivateKey = "1e090b2a266877a9f88a510af2eb0945a63dc69dbce674ccd83272717d4175cf";

		this.network = {
			version:1,
			network:'TESTNET',
			generationHash:'7fccd304802016bebbcd342a332f91ff1f3bb5e902988b352697be245f48e836',
			currencyMosaicId:0x3A8416DB2D53B6C8n,
			currencyNamespaceId:0xE74B99BA41F4AFEEn,
			currencyDivisibility:6,
			epochAdjustment:1637848847,
			catjasonBase:"https://xembook.github.io/tsunagi-sdk/catjson/",
			wellknownNodes:[
				'https://sym-test.opening-line.jp:3001',
				'https://sym-test.opening-line.jp:3001',
				'https://sym-test.opening-line.jp:3001',
			]
		}
		const epochAdjustment = 1637848847; //テストネットの誕生時刻 Thu Nov 25 2021 23:00:47 GMT+0900 (日本標準時)
		const value = epochAdjustment * 1000;
		this.deadline = BigInt(value);
		
	});

	describe('aggregate complete transaction', () => {

		it('resolves 3 account transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}
			//Bob->Caroll
			let tx2 = {
				type:'TRANSFER',
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				recipient_address:"TDZBCWHAVA62R4JFZJJUXQWXLIRTUK5KZHFR5AQ",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Carol! This is Bob.",
			}
			//Caroll->Alice
			let tx3 = {
				type:'TRANSFER',
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				recipient_address:"TBUXMJAYYW3EH3XHBZXSBVGVKXKZS4EH26TINKI",
				mosaics:[
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
				],
				message:"Hello Alice, This is Carol.",
			}

			let cosignature1 = {
				version:0n,
				signer_public_key:"6199BAE3B241DF60418E258D046C22C8C1A5DE2F4F325753554E7FD9C650AFEC",
				signature:"",
			}

			let cosignature2 = {
				version:0n,
				signer_public_key:"886ADFBD4213576D63EA7E7A4BECE61C6933C27CD2FF36F85155C8FEBFB6EB4E",
				signature:"",
			}

			let aggTx = {
				type:'AGGREGATE_COMPLETE',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:1000000n,
				deadline:this.deadline,
				transactions:[tx1,tx2,tx3],
				cosignatures:[cosignature1,cosignature2]
			}

			let catjson = await loadCatjson(aggTx,this.network);
			let layout = await loadLayout(aggTx,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(aggTx,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(aggTx.signer_public_key,signature,builtTx,this.network);

			//連署
			cosignature1.signature = cosignTransaction(txHash,this.bobPrivateKey);
			cosignature2.signature = cosignTransaction(txHash,this.carolPrivateKey);

			let cosignaturesLayout = layout.find(lf=>lf.name === "cosignatures");
			let parsedCosignatures = await parseTransaction(preparedTx,[cosignaturesLayout],catjson,network); //構築
			builtTx = updateTransaction(builtTx,"cosignatures","layout",parsedCosignatures[0].layout);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"280300000000000099fa61bacf8076594c15f3cda5f8b2a799b9119bf5c72192162721c3b936c2c92c6f8b8b85cb5d47e853ada36f9cc2cf6aeaaa67575bb282c6c0970314fa39015f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb000000000198414140420f0000000000981266577d010000ae67220a53b24a241f2da951ba6cfe044aedc42a0afb5f2742c5a454e3c9c6e1b0010000000000008c000000000000005f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21000000008a000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afec000000000198544198f21158e0a83da8f125ca534bc2d75a233a2baac9cb1e821a00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f204361726f6c21205468697320697320426f622e0000000000008c00000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4e00000000019854419869762418c5b643eee70e6f20d4d555d5997087d7a686a91c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f20416c6963652c2054686973206973204361726f6c2e0000000000000000000000006199bae3b241df60418e258d046c22c8c1a5de2f4f325753554e7fd9c650afec6ea8ac34f92e3d17b64e7edcc9ee06172bf710b4a859a30da917e8e97f42d0cda4d7d36c9a2c439006a9461dfd1ed3b2f48b7b0c753a55c01e5b51b679cd79060000000000000000886adfbd4213576d63ea7e7a4bece61c6933c27cd2ff36f85155c8febfb6eb4eb00577f93b7aff5b1388ddbc63c97517eadb348cbba58a0f8daaa0a6ab780a3da842dffef1f8e3755dfd09b16acd637ffcb72ca9b7a559cba8cc80496f5a9e06"
			);
			
		})

	});


	describe('transfer transaction', () => {

		it('resolves 2 mosaic transfer', async () => {

			//Alice->Bob
			let tx1 = {
				type:'TRANSFER',
				signer_public_key:"5f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb",
				fee:25000n,
				deadline:this.deadline,
				recipient_address:"TCO7HLVDQUX6V7C737BCM3VYJ3MKP6REE2EKROA",
				mosaics:[
					{mosaic_id: 0x2A09B7F9097934C2n, amount: 1n},
					{mosaic_id: 0x3A8416DB2D53B6C8n, amount: 100n},
				],
				message:"Hello Tsunagi(Catjson) SDK!",
			}

			let catjson = await loadCatjson(tx1,this.network);
			let layout = await loadLayout(tx1,catjson,false); //isEmbedded false

			let preparedTx = await prepareTransaction(tx1,layout,this.network); //TX事前準備
			let parsedTx   = await parseTransaction(preparedTx,layout,catjson,this.network); //TX解析
			let builtTx    = buildTransaction(parsedTx); //TX構築

			let signature = signTransaction(builtTx,this.privateKey,this.network);
			builtTx = updateTransaction(builtTx,"signature","value",signature);

			//トランザクションハッシュ作成
			let txHash = hashTransaction(tx1.signer_public_key,signature,builtTx,this.network);

			let payload = hexlifyTransaction(builtTx);
			console.log(payload)
			expect(payload)
			.toEqual(
				"dc000000000000008c79ea7b4e2ca00a5b56534cabb777a8f65aa74ba27489ba1df005bc477c1a3050465178f247b64754504c1fa50e0f11688b069bc7b75a8381843677374eac075f594dfc018578662e0b5a2f5f83ecfb1cda2b32e29ff1d9b2c5e7325c4cf7cb0000000001985441a861000000000000981266577d010000989df3aea3852feafc5fdfc2266eb84ed8a7fa242688a8b81c00020000000000c2347909f9b7092a0100000000000000c8b6532ddb16843a64000000000000000048656c6c6f205473756e616769284361746a736f6e292053444b21"
			);
		})
	});



});//symbol-sdk
</script>

</body>
</html>
